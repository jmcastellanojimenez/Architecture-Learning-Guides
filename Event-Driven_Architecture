## ğŸ¯ **Why Event-Driven?**

### âŒ **Problem: Monolith â†’ Microservices**
```
UserService â”€â”€HTTPâ”€â”€â†’ VideoService
    â†“ If VideoService fails...
ğŸ’¥ EVERYTHING CRASHES
```

### âœ… **Solution: Domain Events**
```
UserService â”€â”€eventâ”€â”€â†’ Message Broker â”€â”€â†’ VideoService
    â†“ If VideoService fails...
ğŸ˜ UserService keeps working
```

---

## ğŸ—ï¸ **Basic Architecture**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRODUCER   â”‚â”€â”€â”€â–¶â”‚   BROKER    â”‚â”€â”€â”€â–¶â”‚  CONSUMER   â”‚
â”‚ (Microservice)â”‚   â”‚ (RabbitMQ/  â”‚   â”‚(Microservice)â”‚
â”‚             â”‚    â”‚  AWS SNS)   â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¨ **Message vs Event**

### ğŸ­ **Event** = What happened in the domain
```json
{
  "type": "video_created",
  "data": { "videoId": "123", "userId": "456" }
}
```

### ğŸ“¦ **Message** = Container that transports the event
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MESSAGE (unit in the queue)     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Headers: timestamp, etc     â”‚ â”‚
â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚ â”‚ Body: EVENT (JSON)          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ **Technology Solutions**

### ğŸ° **RabbitMQ (AMQP)**
```
Producer â†’ Exchange â†’ Queue â†’ Consumer
           (Router)  (Buffer)
```

**Exchange Types:**
- ğŸ”Š **Fanout**: Broadcast to all queues
- ğŸ¯ **Direct**: Exact routing key match
- ğŸ”— **Topic**: Routing key with wildcards (`video.*`)

### â˜ï¸ **AWS SNS + SQS**
```
Producer â†’ SNS Topic â†’ SQS Queue â†’ Consumer
           (Exchange)  (RabbitMQ Queue)
```

**Filtering:**
```json
{
  "MessageAttributes": {
    "event_type": "codelytv.video.1.event.video.published"
  }
}
```

### ğŸŒŠ **Kafka/Kinesis = Streaming**
```
âŒ NO for domain events
âœ… YES for data streams (logs, analytics)
```

---

## ğŸ¨ **Naming Conventions**

### ğŸ“‹ **Routing Key (AsyncAPI)**
```
codelytv.video.1.event.video.published
â”‚       â”‚     â”‚ â”‚     â”‚     â”‚
â”‚       â”‚     â”‚ â”‚     â”‚     â””â”€ Event (past tense)
â”‚       â”‚     â”‚ â”‚     â””â”€ Entity
â”‚       â”‚     â”‚ â””â”€ Type (event/command)
â”‚       â”‚     â””â”€ Version
â”‚       â””â”€ Bounded Context
â””â”€ Company
```

### ğŸ·ï¸ **Queue Name**
```
user.notification.notify_user_on_video_published
â”‚    â”‚           â”‚                â”‚
â”‚    â”‚           â”‚                â””â”€ Trigger event
â”‚    â”‚           â””â”€ Action
â”‚    â””â”€ Entity
â””â”€ Service
```

---

## âš ï¸ **Error Management**

### ğŸ”„ **Out-of-Order Events**

**Problem:**
```
Correct order: 1.conversation_created â†’ 2.message_sent
Received order: 1.message_sent â†’ 2.conversation_created âŒ
```

**Solutions:**
1. **Re-queue with counter**: ACK + manual requeue
2. **NACK**: Don't confirm, let RabbitMQ retry

### ğŸ“¬ **Duplicate Events**

| Solution | What it does |
|----------|--------------|
| **Let it crash** ğŸ’¥ | Error â†’ Dead Letter Queue |
| **Deduplication** ğŸ“ | Store processed IDs in DB |
| **Idempotency** ğŸ‘ | Safe operations (UPSERT vs INSERT) |

---

## ğŸ”§ **Circuit Breaker**

### ğŸš¨ **States**
```
CLOSED â”€â”€â”€â”€error rate highâ”€â”€â”€â”€â†’ OPEN
   â†‘                               â”‚
   â”‚                               â”‚ (timeout)
   â”‚                               â†“
   â””â”€â”€â”€â”€success rate OKâ”€â”€â”€â”€ HALF-OPEN
```

**Tools:**
- **Hystrix** (deprecated)
- **Resilience4j** â­ (recommended)
- **Service Mesh** (Istio, Linkerd)

---

## ğŸ“Š **Quick Comparison**

### ğŸ¯ **For Domain Events**
| Tool | Fan-out | DLQ | Complexity | Use Case |
|------|---------|-----|------------|----------|
| **RabbitMQ** | âœ… Easy | âœ… Built-in | ğŸŸ¡ Medium | Microservices |
| **SNS+SQS** | âœ… Easy | âœ… Built-in | ğŸŸ¡ Medium | AWS Cloud |
| **Kafka** | ğŸŸ¡ Manual | ğŸ”´ Manual | ğŸ”´ High | Streaming |
| **Kinesis** | ğŸ”´ No | ğŸ”´ No | ğŸ”´ High | Big Data |

---

## ğŸ† **Best Practices**

### âœ… **DO**
- **1 Exchange per microservice** (RabbitMQ)
- **1 Queue per use case + event**
- **Idempotent operations**
- **Descriptive names**
- **Versioning in routing keys**

### âŒ **DON'T**
- **Don't use Kafka for simple events**
- **Don't ignore duplicates**
- **Don't use sync events for critical flows**

---

## ğŸš€ **Quick Start**

### 1ï¸âƒ£ **Design your event**
```json
{
  "data": {
    "id": "event-uuid",
    "type": "codelytv.video.1.event.video.published",
    "occurred_on": "2025-09-11T14:30:00Z",
    "attributes": {
      "id": "video-123",
      "user_id": "user-456"
    }
  }
}
```

### 2ï¸âƒ£ **Configure infrastructure**
```yaml
# RabbitMQ
Exchange: codelytv.video.topic
Queue: user.stats.increment_count_on_video_published
Binding: codelytv.video.*.event.video.published
```

### 3ï¸âƒ£ **Implement idempotent consumer**
```java
@EventHandler("video.published")
public void handle(VideoPublishedEvent event) {
    // âœ… Idempotent
    userRepository.upsert(event.getUserId(), stats);
    
    // âŒ Not idempotent  
    // userStats.increment(event.getUserId());
}
```

---

## ğŸ¯ **TL;DR**

**Event-Driven Architecture** = Decoupled microservices through asynchronous events

**Golden Rule**: An event represents something that **ALREADY HAPPENED** in your domain

**To get started**: RabbitMQ or AWS SNS+SQS, idempotent operations, descriptive names

**Avoid**: Kafka for simple cases, non-idempotent operations, critical sync events

---

*ğŸ“š Based on DDD principles, SOLID, and distributed systems best practices*
